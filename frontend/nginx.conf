# Define o limite: 1 requisição por segundo por IP (1r/s), com memória de 10MB
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=1r/s;

server {
    # Remove a versão do Nginx do cabeçalho (Segurança por obscuridade)
    server_tokens off;
    
    listen 80;

    root /usr/share/nginx/html;
    index index.html index.htm;

    # Limita o tamanho do upload (body) para 10MB. Se passar, retorna 413.
    client_max_body_size 10M;

    # Limita o tamanho do buffer de cabeçalho e corpo para evitar consumo excessivo de RAM
    client_body_buffer_size 10K;
    client_header_buffer_size 1k;
    large_client_header_buffers 2 1k;

    # Se o cliente demorar mais que isso para enviar o corpo ou cabeçalho, corta a conexão.
    client_body_timeout 12;
    client_header_timeout 12;

    
    # Tempo que a conexão fica aberta sem fazer nada (Keep-Alive)
    keepalive_timeout 15;

    # Tempo para enviar a resposta ao cliente
    send_timeout 10;

    # --- PERFORMANCE: Gzip (Comprime os arquivos antes de enviar) ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    # --- SEGURANÇA: Cabeçalhos Globais (Security Headers) ---
    # Protege contra Clickjacking (não deixa seu site abrir num iframe)
    add_header X-Frame-Options "SAMEORIGIN" always;
    # Protege contra MIME Sniffing
    add_header X-Content-Type-Options "nosniff" always;
    # Protege contra XSS básico
    add_header X-XSS-Protection "1; mode=block" always;
    # Controla quanta informação de referência é enviada
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    limit_req_status 429;

    # 1. Rota Específica de Login (Para aplicar o Rate Limit)
    # O Nginx escolhe esta porque é mais específica que '/api/'
    location /api/auth/login {
        # Permite uma explosão de até 5 tentativas, depois bloqueia
        limit_req zone=login_limit burst=5 nodelay;
        
        # Mantém a lógica de proxy. 
        # Nota: Aqui mandamos EXPLICITAMENTE para a rota final no backend
        proxy_pass http://backend:3001/auth/login;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. Rota Geral da API (Para todo o resto do backend)
    location /api/ {
        # A barra no final '/' remove o prefixo '/api/' antes de mandar pro back
        proxy_pass http://backend:3001/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Aumentar timeout para endpoints lentos (relatórios)
        proxy_read_timeout 60s;
    }

    # 3. Frontend (React)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache agressivo para arquivos estáticos (imagens, css, js gerados pelo vite)
    # O Vite gera nomes com hash (ex: index-XyZ.js), então podemos cachear para sempre
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        try_files $uri =404;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Páginas de erro
    error_page   500 502 503 504  /50x.html;
    error_page   429 413 /50x.html;
    location = /50x.html {
        internal;
    }
}